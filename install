#!/bin/bash

# =================================================================
# Installer Script v2 untuk Hokage Reseller Bot
# - Input Admin ID Interaktif
# - Otomatis menghentikan service lama jika ada
# =================================================================

# Hentikan skrip jika ada error
set -e

# --- Variabel Konfigurasi ---
REPO_URL="https://github.com/hokagelegend9999/reseller-bot.git"
INSTALL_DIR="/opt/hokage-bot"
SERVICE_NAME="hokage-bot"

# --- Warna untuk Output ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# --- Fungsi-fungsi ---

# Fungsi untuk memeriksa apakah skrip dijalankan sebagai root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${YELLOW}Skrip ini harus dijalankan dengan sudo atau sebagai user root.${NC}"
        exit 1
    fi
}

# <<< BARU >>> Fungsi untuk menghentikan service yang sudah ada
stop_existing_service() {
    echo -e "${GREEN}>>> Memeriksa apakah ada service lama yang berjalan...${NC}"
    # Opsi --quiet akan membuat perintah tidak menghasilkan output, hanya exit code
    if systemctl is-active --quiet "${SERVICE_NAME}.service"; then
        echo -e "${YELLOW}Layanan '${SERVICE_NAME}' yang lama ditemukan aktif. Menghentikannya sekarang...${NC}"
        systemctl stop "${SERVICE_NAME}.service"
        echo -e "${GREEN}Layanan lama berhasil dihentikan.${NC}"
    else
        echo -e "${GREEN}Tidak ada layanan lama yang aktif ditemukan. Melanjutkan...${NC}"
    fi
}

# Fungsi untuk instalasi dependency
install_dependencies() {
    echo -e "${GREEN}>>> Mengupdate package list dan meng-install dependency...${NC}"
    apt-get update
    apt-get install -y git python3-venv python3-pip
}

# Fungsi untuk clone repository
clone_repo() {
    echo -e "${GREEN}>>> Meng-clone repository dari GitHub...${NC}"
    if [ -d "$INSTALL_DIR" ]; then
        echo -e "${YELLOW}Folder instalasi $INSTALL_DIR sudah ada. Menghapus folder lama...${NC}"
        rm -rf "$INSTALL_DIR"
    fi
    git clone "$REPO_URL" "$INSTALL_DIR"
}

# Fungsi untuk setup virtual environment Python
setup_python_env() {
    echo -e "${GREEN}>>> Membuat virtual environment Python...${NC}"
    python3 -m venv "$INSTALL_DIR/venv"
    
    echo -e "${GREEN}>>> Meng-install library Python dari requirements.txt...${NC}"
    "$INSTALL_DIR/venv/bin/pip" install --upgrade pip
    "$INSTALL_DIR/venv/bin/pip" install -r "$INSTALL_DIR/requirements.txt"
}

# Fungsi untuk membuat file .env
create_env_file() {
    echo -e "${GREEN}>>> Membuat file konfigurasi .env...${NC}"
    
    echo -e "${YELLOW}Harap masukkan informasi rahasia Anda. Data ini akan disimpan di $INSTALL_DIR/.env${NC}"
    read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
    read -p "Masukkan KMSP_API_KEY Anda: " KMSP_API_KEY
    # <<< BARU >>> Prompt untuk ADMIN_IDS
    read -p "Masukkan ID Telegram Admin Anda (jika lebih dari satu, pisahkan dengan koma): " ADMIN_IDS

    # Membuat file .env
    cat << EOF > "$INSTALL_DIR/.env"
# File untuk menyimpan semua rahasia bot
BOT_TOKEN=${BOT_TOKEN}
KMSP_API_KEY=${KMSP_API_KEY}
ADMIN_IDS=${ADMIN_IDS}
EOF

    # Mengamankan file .env
    chmod 600 "$INSTALL_DIR/.env"
    echo -e "${GREEN}File .env berhasil dibuat dan diamankan.${NC}"
}

# Fungsi untuk membuat service systemd
create_systemd_service() {
    echo -e "${GREEN}>>> Membuat systemd service file...${NC}"
    
    SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"

    cat << EOF > "$SERVICE_FILE"
[Unit]
Description=Hokage Reseller Bot Service
After=network.target

[Service]
User=root
Group=root
WorkingDirectory=${INSTALL_DIR}
ExecStart=${INSTALL_DIR}/venv/bin/python3 main.py
Restart=always
EnvironmentFile=${INSTALL_DIR}/.env
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    echo -e "${GREEN}File service ${SERVICE_NAME}.service berhasil dibuat.${NC}"
}

# Fungsi untuk menjalankan service
start_service() {
    echo -e "${GREEN}>>> Memuat ulang daemon, mengaktifkan, dan menjalankan service...${NC}"
    systemctl daemon-reload
    systemctl enable "${SERVICE_NAME}.service"
    systemctl start "${SERVICE_NAME}.service"
}

# --- Main Logic ---
main() {
    check_root
    echo -e "${GREEN}--- Memulai Instalasi Hokage Reseller Bot v2 ---${NC}"
    
    stop_existing_service
    install_dependencies
    clone_repo
    setup_python_env
    create_env_file
    create_systemd_service
    start_service
    
    echo -e "\n${GREEN}===============================================${NC}"
    echo -e "${GREEN} ✅ INSTALASI SELESAI! ✅ ${NC}"
    echo -e "${GREEN}===============================================${NC}"
    echo -e "Bot Anda sekarang berjalan sebagai service bernama '${YELLOW}${SERVICE_NAME}${NC}'."
    echo -e "Untuk mengecek statusnya, gunakan: ${YELLOW}sudo systemctl status ${SERVICE_NAME}${NC}"
    echo -e "Untuk melihat log-nya secara real-time, gunakan: ${YELLOW}sudo journalctl -u ${SERVICE_NAME} -f${NC}"
}

# Jalankan fungsi main
main
